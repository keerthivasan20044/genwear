import React, { useState, useEffect, useCallback } from 'react'\nimport { useSearchParams } from 'react-router-dom'\nimport { Filter, Grid, List, Search, SlidersHorizontal } from 'lucide-react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { productAPI } from '../services/api'\nimport ProductCard from '../components/products/ProductCard'\nimport FilterSidebarNew from '../components/products/FilterSidebarNew'\nimport ProductSkeleton from '../components/products/ProductSkeleton'\nimport SortDropdown from '../components/products/SortDropdown'\nimport { useAnalytics } from '../hooks/useRealTime'\n\nconst Products = () => {\n  const [searchParams, setSearchParams] = useSearchParams()\n  const [products, setProducts] = useState([])\n  const [filters, setFilters] = useState({})\n  const [loading, setLoading] = useState(true)\n  const [error, setError] = useState(null)\n  const [viewMode, setViewMode] = useState('grid')\n  const [showFilters, setShowFilters] = useState(false)\n  const [searchTerm, setSearchTerm] = useState('')\n  const { trackPageView } = useAnalytics()\n\n  // Get active filters from URL params\n  const getActiveFilters = useCallback(() => {\n    const filters = {}\n    for (const [key, value] of searchParams.entries()) {\n      if (value) filters[key] = value\n    }\n    return filters\n  }, [searchParams])\n\n  const activeFilters = getActiveFilters()\n\n  // Fetch products with filters\n  const fetchProducts = useCallback(async () => {\n    try {\n      setLoading(true)\n      setError(null)\n      \n      const params = Object.fromEntries(searchParams.entries())\n      const response = await productAPI.getProducts(params)\n      \n      setProducts(response.products || [])\n      setFilters(response.filters || {})\n    } catch (err) {\n      setError(err.message || 'Failed to fetch products')\n      console.error('Fetch products error:', err)\n    } finally {\n      setLoading(false)\n    }\n  }, [searchParams])\n\n  // Handle filter changes\n  const handleFilterChange = useCallback((newFilters) => {\n    const updatedParams = new URLSearchParams(searchParams)\n    \n    Object.entries(newFilters).forEach(([key, value]) => {\n      if (value && value !== '') {\n        updatedParams.set(key, value)\n      } else {\n        updatedParams.delete(key)\n      }\n    })\n    \n    setSearchParams(updatedParams)\n  }, [searchParams, setSearchParams])\n\n  // Clear all filters\n  const handleClearFilters = useCallback(() => {\n    setSearchParams({})\n    setSearchTerm('')\n  }, [setSearchParams])\n\n  // Handle search\n  const handleSearch = useCallback((e) => {\n    e.preventDefault()\n    if (searchTerm.trim()) {\n      handleFilterChange({ search: searchTerm.trim() })\n    } else {\n      const params = new URLSearchParams(searchParams)\n      params.delete('search')\n      setSearchParams(params)\n    }\n  }, [searchTerm, handleFilterChange, searchParams, setSearchParams])\n\n  // Handle sort change\n  const handleSortChange = useCallback((sortValue) => {\n    handleFilterChange({ sort: sortValue })\n  }, [handleFilterChange])\n\n  // Initialize search term from URL\n  useEffect(() => {\n    const searchFromUrl = searchParams.get('search') || ''\n    setSearchTerm(searchFromUrl)\n  }, [searchParams])\n\n  // Fetch products when filters change\n  useEffect(() => {\n    fetchProducts()\n  }, [fetchProducts])\n\n  // Track page view\n  useEffect(() => {\n    trackPageView('/products')\n  }, [trackPageView])\n\n  // Handle mobile filter toggle\n  const toggleFilters = () => {\n    setShowFilters(!showFilters)\n  }\n\n  const getFilterCount = () => {\n    return Object.keys(activeFilters).filter(key => \n      activeFilters[key] && activeFilters[key] !== ''\n    ).length\n  }\n\n  return (\n    <div className=\"min-h-screen bg-slate-50\">\n      {/* Header */}\n      <div className=\"bg-white border-b border-gray-200 sticky top-20 z-30\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"py-6\">\n            {/* Title and Search */}\n            <div className=\"flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6\">\n              <div>\n                <h1 className=\"text-3xl font-bold text-gray-900\">Products</h1>\n                <p className=\"text-gray-600 mt-1\">\n                  {loading ? 'Loading...' : `${products.length} products found`}\n                </p>\n              </div>\n              \n              {/* Search Bar */}\n              <form onSubmit={handleSearch} className=\"flex-1 max-w-md\">\n                <div className=\"relative\">\n                  <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5\" />\n                  <input\n                    type=\"text\"\n                    value={searchTerm}\n                    onChange={(e) => setSearchTerm(e.target.value)}\n                    placeholder=\"Search products...\"\n                    className=\"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-colors\"\n                  />\n                </div>\n              </form>\n            </div>\n\n            {/* Controls */}\n            <div className=\"flex items-center justify-between\">\n              {/* Filter Toggle & Count */}\n              <div className=\"flex items-center gap-4\">\n                <button\n                  onClick={toggleFilters}\n                  className=\"lg:hidden flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-xl transition-colors\"\n                >\n                  <SlidersHorizontal className=\"w-4 h-4\" />\n                  <span>Filters</span>\n                  {getFilterCount() > 0 && (\n                    <span className=\"bg-orange-600 text-white text-xs px-2 py-1 rounded-full\">\n                      {getFilterCount()}\n                    </span>\n                  )}\n                </button>\n                \n                {/* Active Filters Display */}\n                {getFilterCount() > 0 && (\n                  <div className=\"hidden lg:flex items-center gap-2\">\n                    <span className=\"text-sm text-gray-600\">Active filters:</span>\n                    <div className=\"flex flex-wrap gap-2\">\n                      {Object.entries(activeFilters).map(([key, value]) => {\n                        if (!value) return null\n                        return (\n                          <span\n                            key={key}\n                            className=\"inline-flex items-center gap-1 px-3 py-1 bg-orange-100 text-orange-700 text-sm rounded-full\"\n                          >\n                            {key}: {value}\n                            <button\n                              onClick={() => handleFilterChange({ [key]: '' })}\n                              className=\"hover:bg-orange-200 rounded-full p-0.5\"\n                            >\n                              Ã—\n                            </button>\n                          </span>\n                        )\n                      })}\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              {/* View Controls */}\n              <div className=\"flex items-center gap-4\">\n                <SortDropdown \n                  value={activeFilters.sort || ''}\n                  onChange={handleSortChange}\n                />\n                \n                <div className=\"flex items-center border border-gray-300 rounded-lg overflow-hidden\">\n                  <button\n                    onClick={() => setViewMode('grid')}\n                    className={`p-2 transition-colors ${\n                      viewMode === 'grid' \n                        ? 'bg-orange-600 text-white' \n                        : 'bg-white text-gray-600 hover:bg-gray-50'\n                    }`}\n                  >\n                    <Grid className=\"w-4 h-4\" />\n                  </button>\n                  <button\n                    onClick={() => setViewMode('list')}\n                    className={`p-2 transition-colors ${\n                      viewMode === 'list' \n                        ? 'bg-orange-600 text-white' \n                        : 'bg-white text-gray-600 hover:bg-gray-50'\n                    }`}\n                  >\n                    <List className=\"w-4 h-4\" />\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        <div className=\"flex gap-8\">\n          {/* Filters Sidebar - Desktop */}\n          <div className=\"hidden lg:block w-80 flex-shrink-0\">\n            <FilterSidebarNew\n              filters={filters}\n              activeFilters={activeFilters}\n              onFilterChange={handleFilterChange}\n              onClearFilters={handleClearFilters}\n            />\n          </div>\n\n          {/* Mobile Filters */}\n          <FilterSidebarNew\n            filters={filters}\n            activeFilters={activeFilters}\n            onFilterChange={handleFilterChange}\n            onClearFilters={handleClearFilters}\n            isMobile={true}\n            isOpen={showFilters}\n            onClose={() => setShowFilters(false)}\n          />\n\n          {/* Products Grid */}\n          <div className=\"flex-1 min-w-0\">\n            {error && (\n              <div className=\"bg-red-50 border border-red-200 rounded-xl p-6 mb-6\">\n                <p className=\"text-red-600\">{error}</p>\n                <button\n                  onClick={fetchProducts}\n                  className=\"mt-2 text-red-700 hover:text-red-800 font-medium\"\n                >\n                  Try again\n                </button>\n              </div>\n            )}\n\n            {loading ? (\n              <div className={`\n                grid gap-6\n                ${viewMode === 'grid' \n                  ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4' \n                  : 'grid-cols-1'\n                }\n              `}>\n                {Array.from({ length: 8 }).map((_, index) => (\n                  <ProductSkeleton key={index} />\n                ))}\n              </div>\n            ) : products.length === 0 ? (\n              <div className=\"text-center py-16\">\n                <div className=\"w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n                  <Search className=\"w-8 h-8 text-gray-400\" />\n                </div>\n                <h3 className=\"text-xl font-semibold text-gray-900 mb-2\">No products found</h3>\n                <p className=\"text-gray-600 mb-6\">Try adjusting your filters or search terms</p>\n                <button\n                  onClick={handleClearFilters}\n                  className=\"btn-primary\"\n                >\n                  Clear all filters\n                </button>\n              </div>\n            ) : (\n              <motion.div\n                layout\n                className={`\n                  grid gap-6\n                  ${viewMode === 'grid' \n                    ? 'grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4' \n                    : 'grid-cols-1'\n                  }\n                `}\n              >\n                <AnimatePresence>\n                  {products.map((product) => (\n                    <motion.div\n                      key={product._id}\n                      layout\n                      initial={{ opacity: 0, y: 20 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      exit={{ opacity: 0, y: -20 }}\n                      transition={{ duration: 0.3 }}\n                    >\n                      <ProductCard \n                        product={product} \n                        viewMode={viewMode}\n                      />\n                    </motion.div>\n                  ))}\n                </AnimatePresence>\n              </motion.div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n}\n\nexport default Products